{% extends "base.html" %}

{% block title %}Dataset Generator - CSPBench{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">
    <i class="bi bi-database me-1"></i>Dataset Generator
</li>
{% endblock %}

{% block header %}
<div class="text-center mb-5">
    <div class="hero-section p-5 rounded-4 shadow" style="background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);">
        <h1 class="display-4 fw-bold text-white mb-3">
            <i class="bi bi-database me-3"></i>Dataset Generator
        </h1>
        <p class="lead text-white-50 mb-0">
            Create synthetic datasets or manage existing ones for algorithm testing
        </p>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Dataset Summary -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center shadow-sm border-0 bg-primary bg-opacity-10 stats-card">
            <div class="card-body py-4">
                <i class="bi bi-database fs-1 text-primary mb-3 stats-icon"></i>
                <h4 class="card-title text-primary fw-bold" id="total-datasets">-</h4>
                <p class="card-text text-muted mb-0">Total Datasets</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm border-0 bg-info bg-opacity-10 stats-card">
            <div class="card-body py-4">
                <i class="bi bi-gear fs-1 text-info mb-3 stats-icon"></i>
                <h4 class="card-title text-info fw-bold" id="generating-datasets">-</h4>
                <p class="card-text text-muted mb-0">Generating</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm border-0 bg-success bg-opacity-10 stats-card">
            <div class="card-body py-4">
                <i class="bi bi-check-circle fs-1 text-success mb-3 stats-icon"></i>
                <h4 class="card-title text-success fw-bold" id="ready-datasets">-</h4>
                <p class="card-text text-muted mb-0">Ready</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm border-0 bg-warning bg-opacity-10 stats-card">
            <div class="card-body py-4">
                <i class="bi bi-hdd fs-1 text-warning mb-3 stats-icon"></i>
                <h4 class="card-title text-warning fw-bold" id="total-size">-</h4>
                <p class="card-text text-muted mb-0">Total Size</p>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Management -->
<div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="bi bi-database me-2"></i>Dataset Management
        </h5>
        <div class="d-flex align-items-center gap-3">
            <span class="badge bg-secondary text-nowrap" id="selected-count">0 selected</span>
            <div class="btn-group btn-group-sm" role="group" id="batch-actions" style="display: none;">
                <button class="btn btn-outline-success" id="download-selected" disabled>
                    <i class="bi bi-download me-1"></i>Download
                </button>
                <button class="btn btn-outline-danger" id="delete-selected" disabled>
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="toggle-filters" data-bs-toggle="collapse" data-bs-target="#filters-section" aria-expanded="false">
                    <i class="bi bi-funnel me-1"></i>Filters
                </button>
                <button class="btn btn-outline-primary btn-sm" id="generate-dataset" data-bs-toggle="modal" data-bs-target="#generateModal">
                    <i class="bi bi-plus-circle me-1"></i>Generate
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="upload-dataset" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-upload me-1"></i>Upload
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="refresh-datasets">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
    
    <!-- Collapsible Filters Section -->
    <div class="collapse" id="filters-section">
        <div class="card-body border-bottom bg-light">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="search-query" class="form-label">Search</label>
                    <input type="text" class="form-control" id="search-query" placeholder="Dataset name, type...">
                </div>
                <div class="col-md-2">
                    <label for="filter-type" class="form-label">Type</label>
                    <select class="form-select" id="filter-type">
                        <option value="">All Types</option>
                        <option value="synthetic">Synthetic</option>
                        <option value="ncbi">NCBI</option>
                        <option value="uploaded">Uploaded</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filter-status" class="form-label">Status</label>
                    <select class="form-select" id="filter-status">
                        <option value="">All Status</option>
                        <option value="ready">Ready</option>
                        <option value="generating">Generating</option>
                        <option value="error">Error</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filter-date-from" class="form-label">From Date</label>
                    <input type="date" class="form-control" id="filter-date-from">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100" id="apply-filters">
                        <i class="bi bi-search me-1"></i>Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-body p-0">
        <!-- Loading indicator -->
        <div id="loading-indicator" class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading datasets...</p>
        </div>

        <!-- Datasets table -->
        <div class="table-responsive" id="datasets-table-container" style="display: none;">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="50">
                            <input type="checkbox" class="form-check-input" id="select-all-checkbox">
                        </th>
                        <th>Dataset Name</th>
                        <th>Type</th>
                        <th>Created</th>
                        <th>Status</th>
                        <th>Sequences</th>
                        <th>Size</th>
                        <th width="200">Actions</th>
                    </tr>
                </thead>
                <tbody id="datasets-table-body">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>

        <!-- Empty state -->
        <div id="empty-state" class="text-center p-5" style="display: none;">
            <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
            <h5 class="text-muted">No datasets found</h5>
            <p class="text-muted">Generate a synthetic dataset or upload your own to get started.</p>
            <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateModal">
                    <i class="bi bi-plus-circle me-1"></i>Generate Dataset
                </button>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-upload me-1"></i>Upload Dataset
                </button>
            </div>
        </div>

        <!-- Error state -->
        <div id="error-state" class="text-center p-5" style="display: none;">
            <i class="bi bi-exclamation-triangle fs-1 text-warning mb-3"></i>
            <h5 class="text-warning">Error loading datasets</h5>
            <p class="text-muted" id="error-message">An unexpected error occurred.</p>
            <button class="btn btn-outline-primary" id="retry-load">
                <i class="bi bi-arrow-clockwise me-1"></i>Retry
            </button>
        </div>
    </div>
</div>

<!-- Generate Dataset Modal -->
<div class="modal fade" id="generateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Synthetic Dataset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="generate-form">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="sequences-count" class="form-label">Number of Sequences</label>
                            <input type="number" class="form-control" id="sequences-count" min="3" max="1000" value="20" required>
                            <div class="form-text">Number of sequences to generate (3-1000)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="sequence-length" class="form-label">Sequence Length</label>
                            <input type="number" class="form-control" id="sequence-length" min="5" max="10000" value="50" required>
                            <div class="form-text">Length of each sequence (5-10000)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="alphabet-type" class="form-label">Alphabet</label>
                            <select class="form-select" id="alphabet-type" required>
                                <option value="ACGT">DNA (ACGT)</option>
                                <option value="ACGU">RNA (ACGU)</option>
                                <option value="ACDEFGHIKLMNPQRSTVWY">Protein (20 amino acids)</option>
                                <option value="01">Binary (01)</option>
                                <option value="custom">Custom...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="generation-method" class="form-label">Generation Method</label>
                            <select class="form-select" id="generation-method" required>
                                <option value="random">Random Generation</option>
                                <option value="noise">Center-based with Noise</option>
                                <option value="clustered">Clustered Sequences</option>
                            </select>
                        </div>
                        <div class="col-12" id="custom-alphabet-container" style="display: none;">
                            <label for="custom-alphabet" class="form-label">Custom Alphabet</label>
                            <input type="text" class="form-control" id="custom-alphabet" placeholder="Enter custom alphabet">
                            <div class="form-text">Define your custom character set</div>
                        </div>
                        <div class="col-12">
                            <label for="dataset-name" class="form-label">Dataset Name (optional)</label>
                            <input type="text" class="form-control" id="dataset-name" placeholder="Leave empty for auto-generated name">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generate-submit">Generate Dataset</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Dataset Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Dataset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="dataset-file" class="form-label">FASTA File</label>
                        <input type="file" class="form-control" id="dataset-file" accept=".fasta,.fa,.fas" required>
                        <div class="form-text">Upload a FASTA file (max 10MB)</div>
                    </div>
                    <div class="mb-3">
                        <label for="upload-dataset-name" class="form-label">Dataset Name (optional)</label>
                        <input type="text" class="form-control" id="upload-dataset-name" placeholder="Leave empty to use file name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="upload-submit">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the selected dataset(s)?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.status-badge {
    font-size: 0.75rem;
}

.status-ready {
    background-color: #d1edff;
    color: #0c5460;
}

.status-generating {
    background-color: #fff3cd;
    color: #856404;
}

.status-error {
    background-color: #f8d7da;
    color: #721c24;
}

.type-synthetic {
    background-color: #e7f3ff;
    color: #0056b3;
}

.type-ncbi {
    background-color: #e6f7ff;
    color: #0958d9;
}

.type-uploaded {
    background-color: #f6ffed;
    color: #389e0d;
}

.dataset-row:hover {
    background-color: rgba(0,123,255,0.1);
}

.dataset-checkbox {
    transform: scale(1.2);
}

.action-btn {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

.table th {
    border-top: none;
    font-weight: 600;
    background-color: #f8f9fa;
}

.stats-card {
    transition: all 0.3s ease;
    cursor: default;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.stats-icon {
    transition: transform 0.3s ease;
}

.stats-card:hover .stats-icon {
    transform: scale(1.1);
}

.bg-primary.bg-opacity-10 {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.bg-info.bg-opacity-10 {
    background-color: rgba(13, 202, 240, 0.1) !important;
}

.bg-success.bg-opacity-10 {
    background-color: rgba(25, 135, 84, 0.1) !important;
}

.bg-warning.bg-opacity-10 {
    background-color: rgba(255, 193, 7, 0.1) !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="/static/js/components/dataset-manager.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const datasetManager = new DatasetManager();
    datasetManager.initialize();
    
    // Custom alphabet toggle
    document.getElementById('alphabet-type')?.addEventListener('change', (e) => {
        const customContainer = document.getElementById('custom-alphabet-container');
        if (e.target.value === 'custom') {
            customContainer.style.display = 'block';
        } else {
            customContainer.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
                <div class="form-group">
                    <label for="synthetic-seed">Seed (Optional)</label>
                    <input type="number" id="synthetic-seed" name="seed" 
                           placeholder="Enter seed for reproducibility">
                    <small>Leave empty for random generation</small>
                </div>
                
                <div class="form-group">
                    <label for="synthetic-filename">Output Filename</label>
                    <input type="text" id="synthetic-filename" name="filename" 
                           placeholder="auto-generated" pattern="[a-zA-Z0-9._-]+\.fasta$">
                    <small>Filename ending in .fasta (auto-generated if empty)</small>
                </div>
            </div>
            
            <button type="submit" class="generate-button">
                üß™ Generate Synthetic Dataset
            </button>
        </form>
    </div>

    <!-- NCBI Dataset Downloader -->
    <div id="ncbi-generator" class="generator-section">
        <h3>üåê NCBI Dataset Download</h3>
        <form id="ncbi-form" class="generator-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="ncbi-query">Search Query</label>
                    <input type="text" id="ncbi-query" name="query" 
                           value="COI[Gene]" required>
                    <small>NCBI search query (e.g., "COI[Gene]", "ribosomal RNA")</small>
                </div>
                
                <div class="form-group">
                    <label for="ncbi-database">Database</label>
                    <select id="ncbi-database" name="database" required>
                        <option value="nucleotide">Nucleotide</option>
                        <option value="protein">Protein</option>
                        <option value="genome">Genome</option>
                        <option value="sra">SRA</option>
                    </select>
                    <small>NCBI database to search</small>
                </div>
                
                <div class="form-group">
                    <label for="ncbi-max-sequences">Max Sequences</label>
                    <input type="number" id="ncbi-max-sequences" name="max_sequences" 
                           min="1" max="1000" value="50" required>
                    <small>Maximum sequences to download (1-1000)</small>
                </div>
                
                <div class="form-group">
                    <label for="ncbi-min-length">Min Length</label>
                    <input type="number" id="ncbi-min-length" name="min_length" 
                           min="1" max="50000" value="100" required>
                    <small>Minimum sequence length</small>
                </div>
                
                <div class="form-group">
                    <label for="ncbi-max-length">Max Length</label>
                    <input type="number" id="ncbi-max-length" name="max_length" 
                           min="1" max="50000" value="2000" required>
                    <small>Maximum sequence length</small>
                </div>
                
                <div class="form-group">
                    <label for="ncbi-filename">Output Filename</label>
                    <input type="text" id="ncbi-filename" name="filename" 
                           placeholder="auto-generated" pattern="[a-zA-Z0-9._-]+\.fasta$">
                    <small>Filename ending in .fasta (auto-generated if empty)</small>
                </div>
            </div>
            
            <button type="submit" class="generate-button">
                üåê Download NCBI Dataset
            </button>
        </form>
    </div>
    
    <!-- Generation Status -->
    <div id="generation-status" class="status-section" style="display: none;">
        <h3>üìä Generation Status</h3>
        <div class="status-content">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div id="status-message" class="status-message">Initializing...</div>
            <div id="status-details" class="status-details"></div>
        </div>
        <button id="cancel-generation" class="cancel-button" style="display: none;">
            ‚ùå Cancel Generation
        </button>
    </div>
    
    <!-- Results Section -->
    <div id="results-section" class="results-section" style="display: none;">
        <h3>‚úÖ Dataset Generated Successfully</h3>
        <div class="results-content">
            <div class="dataset-info">
                <h4>Dataset Information</h4>
                <div id="dataset-details" class="dataset-details">
                    <!-- Dataset details will be populated here -->
                </div>
            </div>
            
            <div class="dataset-preview">
                <h4>Preview (First 5 sequences)</h4>
                <div id="sequence-preview" class="sequence-preview">
                    <!-- Sequence preview will be populated here -->
                </div>
            </div>
            
            <div class="results-actions">
                <button id="download-dataset" class="download-button">
                    üíæ Download Dataset
                </button>
                <button id="use-in-execution" class="use-button">
                    üöÄ Use in Algorithm Execution
                </button>
                <button id="generate-another" class="secondary-button">
                    üîÑ Generate Another Dataset
                </button>
            </div>
        </div>
    </div>
    
    <!-- Saved Datasets Manager -->
    <div class="saved-datasets-section">
        <h3>üìÅ Saved Datasets</h3>
        <div id="saved-datasets-list" class="datasets-list">
            <div class="loading-message">Loading saved datasets...</div>
        </div>
        <button id="refresh-datasets" class="refresh-button">
            üîÑ Refresh List
        </button>
    </div>
</div>

<script>
// Initialize the DatasetGenerator component when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the DatasetGenerator component if available
    if (typeof DatasetGenerator !== 'undefined') {
        window.datasetGenerator = new DatasetGenerator();
    } else {
        console.warn('DatasetGenerator component not available, using fallback');
    }
});

// Basic tab switching (fallback if DatasetGenerator not loaded)
function switchDatasetType(type) {
    const syntheticTab = document.getElementById('synthetic-tab');
    const ncbiTab = document.getElementById('ncbi-tab');
    const uploadTab = document.getElementById('upload-tab');
    const syntheticGenerator = document.getElementById('synthetic-generator');
    const ncbiGenerator = document.getElementById('ncbi-generator');
    const uploadGenerator = document.getElementById('upload-generator');
    
    // Remove all active classes
    [syntheticTab, ncbiTab, uploadTab].forEach(tab => tab?.classList.remove('active'));
    [syntheticGenerator, ncbiGenerator, uploadGenerator].forEach(gen => gen?.classList.remove('active'));
    
    // Add active class to selected type
    if (type === 'synthetic') {
        syntheticTab?.classList.add('active');
        syntheticGenerator?.classList.add('active');
    } else if (type === 'ncbi') {
        ncbiTab?.classList.add('active');
        ncbiGenerator?.classList.add('active');
    } else if (type === 'upload') {
        uploadTab?.classList.add('active');
        uploadGenerator?.classList.add('active');
    }
}
</script>
{% endblock %}
