{% extends "base.html" %}

{% block title %}Result Details - CSPBench{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="/results" class="text-decoration-none">
        <i class="bi bi-download me-1"></i>Results
    </a>
</li>
<li class="breadcrumb-item active" aria-current="page">
    {{ session_id }}
</li>
{% endblock %}

{% block header %}
<div class="text-center mb-5">
    <div class="hero-section p-5 rounded-4 shadow" style="background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);">
        <h1 class="display-4 fw-bold text-white mb-3">
            <i class="bi bi-file-earmark-text me-3"></i>Result Details
        </h1>
        <p class="lead text-white-50 mb-0">
            Detailed view for session <code class="text-white">{{ session_id }}</code>
        </p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Session Info -->
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2"></i>Session Information
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-success btn-sm" id="download-full">
                        <i class="bi bi-download me-1"></i>Download All
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="refresh-details">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body" id="session-info">
                <!-- Loading placeholder -->
                <div class="text-center p-4" id="loading-session">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading session details...</p>
                </div>
            </div>
        </div>

        <!-- Files -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="bi bi-folder me-2"></i>Files
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="files-table">
                        <thead class="table-light">
                            <tr>
                                <th>File</th>
                                <th>Type</th>
                                <th>Size</th>
                                <th width="150">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="files-list">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Detailed Results -->
        <div class="card shadow-sm" id="detailed-results-card" style="display: none;">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up me-2"></i>Detailed Results
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Algorithm Results</h6>
                        <div id="algorithm-results">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Performance Metrics</h6>
                        <div id="performance-metrics">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>Raw Results Data</h6>
                    <div class="bg-light p-3 rounded">
                        <pre><code id="raw-results-data">Loading...</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightning me-2"></i>Quick Downloads
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" data-file-type="json">
                        <i class="bi bi-filetype-json me-1"></i>JSON Results
                    </button>
                    <button class="btn btn-outline-primary" data-file-type="csv">
                        <i class="bi bi-filetype-csv me-1"></i>CSV Results
                    </button>
                    <button class="btn btn-outline-primary" data-file-type="log">
                        <i class="bi bi-file-text me-1"></i>Log File
                    </button>
                    <button class="btn btn-outline-primary" data-file-type="plots">
                        <i class="bi bi-graph-up me-1"></i>Plots & Charts
                    </button>
                    <button class="btn btn-outline-primary" data-file-type="report">
                        <i class="bi bi-file-earmark-pdf me-1"></i>HTML Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Session Summary -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clipboard-data me-2"></i>Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center" id="summary-stats">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear me-2"></i>Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/results" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Back to Results
                    </a>
                    <button class="btn btn-outline-warning" id="re-run-session">
                        <i class="bi bi-arrow-clockwise me-1"></i>Re-run Session
                    </button>
                    <button class="btn btn-outline-danger" id="delete-session">
                        <i class="bi bi-trash me-1"></i>Delete Session
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this session?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-session">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.session-stat {
    text-align: center;
    padding: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.session-stat .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #0d6efd;
}

.session-stat .stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.file-row:hover {
    background-color: rgba(0,123,255,0.1);
}

.file-icon {
    font-size: 1.2rem;
    margin-right: 0.5rem;
}

.code-viewer {
    max-height: 400px;
    overflow-y: auto;
    font-size: 0.875rem;
}

.status-completed {
    color: #198754;
    background-color: #d1e7dd;
}

.status-failed {
    color: #dc3545;
    background-color: #f8d7da;
}

.status-timeout {
    color: #fd7e14;
    background-color: #fff3cd;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
class ResultDetailsManager {
    constructor(sessionId) {
        this.sessionId = sessionId;
        this.apiClient = window.apiClient || new APIClient();
        this.bindEvents();
    }

    initialize() {
        this.loadSessionDetails();
    }

    bindEvents() {
        // Download buttons
        document.getElementById('download-full')?.addEventListener('click', 
            () => this.downloadFull());
        
        document.querySelectorAll('[data-file-type]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const fileType = e.target.closest('[data-file-type]').dataset.fileType;
                this.downloadFile(fileType);
            });
        });

        // Action buttons
        document.getElementById('refresh-details')?.addEventListener('click', 
            () => this.loadSessionDetails());
        document.getElementById('delete-session')?.addEventListener('click', 
            () => this.showDeleteModal());
        document.getElementById('confirm-delete-session')?.addEventListener('click', 
            () => this.deleteSession());
        document.getElementById('re-run-session')?.addEventListener('click', 
            () => this.reRunSession());
    }

    async loadSessionDetails() {
        try {
            document.getElementById('loading-session').style.display = 'block';
            
            const details = await this.apiClient.get(`/api/results/${this.sessionId}`);
            this.renderSessionInfo(details);
            this.renderFilesList(details.files || []);
            this.renderSummary(details);
            
            if (details.detailed_results) {
                this.renderDetailedResults(details.detailed_results);
            }

            document.getElementById('loading-session').style.display = 'none';

        } catch (error) {
            console.error('Failed to load session details:', error);
            this.showError('Failed to load session details: ' + error.message);
        }
    }

    renderSessionInfo(details) {
        const container = document.getElementById('session-info');
        const timestamp = new Date(details.timestamp).toLocaleString();
        
        container.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Session ID:</strong></td>
                            <td><code>${details.session_id}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Algorithm:</strong></td>
                            <td>${details.algorithm ? `<span class="badge bg-info">${details.algorithm}</span>` : '-'}</td>
                        </tr>
                        <tr>
                            <td><strong>Dataset:</strong></td>
                            <td>${details.dataset_name || '-'}</td>
                        </tr>
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td><span class="badge status-${details.status}">${details.status}</span></td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Timestamp:</strong></td>
                            <td>${timestamp}</td>
                        </tr>
                        <tr>
                            <td><strong>Execution Time:</strong></td>
                            <td>${details.execution_time ? details.execution_time.toFixed(2) + 's' : '-'}</td>
                        </tr>
                        <tr>
                            <td><strong>Best String:</strong></td>
                            <td>${details.best_string ? `<code>${details.best_string}</code>` : '-'}</td>
                        </tr>
                        <tr>
                            <td><strong>Max Distance:</strong></td>
                            <td>${details.max_distance || '-'}</td>
                        </tr>
                    </table>
                </div>
            </div>
        `;
    }

    renderFilesList(files) {
        const tbody = document.getElementById('files-list');
        
        tbody.innerHTML = files.map(file => {
            const extension = file.split('.').pop().toLowerCase();
            const icon = this.getFileIcon(extension);
            const fileType = this.getFileType(extension);
            
            return `
                <tr class="file-row">
                    <td>
                        <i class="${icon} file-icon"></i>
                        <span>${file}</span>
                    </td>
                    <td><span class="badge bg-secondary">${fileType}</span></td>
                    <td>-</td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm download-individual-file" 
                                data-file="${file}" title="Download">
                            <i class="bi bi-download"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        // Bind download events for individual files
        document.querySelectorAll('.download-individual-file').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const fileName = e.target.closest('[data-file]').dataset.file;
                this.downloadIndividualFile(fileName);
            });
        });
    }

    renderSummary(details) {
        const container = document.getElementById('summary-stats');
        
        container.innerHTML = `
            <div class="session-stat">
                <div class="stat-value">${details.files?.length || 0}</div>
                <div class="stat-label">Files</div>
            </div>
            <div class="session-stat">
                <div class="stat-value">${details.size_mb || 0} MB</div>
                <div class="stat-label">Total Size</div>
            </div>
            <div class="session-stat">
                <div class="stat-value">${details.execution_time ? details.execution_time.toFixed(2) + 's' : '-'}</div>
                <div class="stat-label">Runtime</div>
            </div>
        `;
    }

    renderDetailedResults(results) {
        document.getElementById('detailed-results-card').style.display = 'block';
        
        // Algorithm results
        const algorithmContainer = document.getElementById('algorithm-results');
        algorithmContainer.innerHTML = `
            <table class="table table-sm">
                <tr><td><strong>Best String:</strong></td><td><code>${results.best_string || '-'}</code></td></tr>
                <tr><td><strong>Max Distance:</strong></td><td>${results.max_distance || '-'}</td></tr>
                <tr><td><strong>Algorithm:</strong></td><td>${results.algorithm || '-'}</td></tr>
            </table>
        `;

        // Performance metrics
        const performanceContainer = document.getElementById('performance-metrics');
        performanceContainer.innerHTML = `
            <table class="table table-sm">
                <tr><td><strong>Execution Time:</strong></td><td>${results.execution_time ? results.execution_time.toFixed(2) + 's' : '-'}</td></tr>
                <tr><td><strong>Memory Usage:</strong></td><td>${results.memory_usage || '-'}</td></tr>
                <tr><td><strong>CPU Usage:</strong></td><td>${results.cpu_usage || '-'}</td></tr>
            </table>
        `;

        // Raw data
        document.getElementById('raw-results-data').textContent = JSON.stringify(results, null, 2);
    }

    getFileIcon(extension) {
        const iconMap = {
            'json': 'bi bi-filetype-json text-warning',
            'csv': 'bi bi-filetype-csv text-success',
            'log': 'bi bi-file-text text-info',
            'html': 'bi bi-filetype-html text-danger',
            'png': 'bi bi-image text-primary',
            'jpg': 'bi bi-image text-primary',
            'jpeg': 'bi bi-image text-primary',
            'pdf': 'bi bi-file-earmark-pdf text-danger',
            'txt': 'bi bi-file-text text-muted'
        };
        return iconMap[extension] || 'bi bi-file-earmark text-muted';
    }

    getFileType(extension) {
        const typeMap = {
            'json': 'JSON',
            'csv': 'CSV',
            'log': 'Log',
            'html': 'HTML',
            'png': 'Image',
            'jpg': 'Image',
            'jpeg': 'Image',
            'pdf': 'PDF',
            'txt': 'Text'
        };
        return typeMap[extension] || 'File';
    }

    downloadFull() {
        window.open(`/api/results/${this.sessionId}/download`, '_blank');
    }

    downloadFile(fileType) {
        window.open(`/api/results/${this.sessionId}/files/${fileType}`, '_blank');
    }

    downloadIndividualFile(fileName) {
        // For individual files, we'd need to implement a more specific endpoint
        // For now, we'll use the general file type download
        const extension = fileName.split('.').pop().toLowerCase();
        const typeMap = {
            'json': 'json',
            'csv': 'csv',
            'log': 'log',
            'html': 'report',
            'png': 'plots'
        };
        const fileType = typeMap[extension] || 'json';
        this.downloadFile(fileType);
    }

    showDeleteModal() {
        const modal = new bootstrap.Modal(document.getElementById('deleteSessionModal'));
        modal.show();
    }

    async deleteSession() {
        try {
            await this.apiClient.delete(`/api/results/${this.sessionId}`);
            
            // Hide modal and redirect
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteSessionModal'));
            modal.hide();
            
            // Show success message and redirect
            alert('Session deleted successfully');
            window.location.href = '/results';

        } catch (error) {
            console.error('Failed to delete session:', error);
            alert('Failed to delete session: ' + error.message);
        }
    }

    reRunSession() {
        // This would require access to the original execution parameters
        alert('Re-run functionality would be implemented to recreate the execution with the same parameters');
    }

    showError(message) {
        document.getElementById('loading-session').style.display = 'none';
        document.getElementById('session-info').innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                ${message}
            </div>
        `;
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    const sessionId = '{{ session_id }}';
    const manager = new ResultDetailsManager(sessionId);
    manager.initialize();
});
</script>
{% endblock %}
