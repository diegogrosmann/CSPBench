{% extends "base.html" %}

{% block title %}Results - CSPBench{% endblock %}

{% block extra_css %}
<style>
    .results-viewer {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .results-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .results-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .results-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    }

    .card-header {
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 1.5rem;
        font-weight: 600;
        color: #495057;
    }

    .notice {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem;
        color: #856404;
    }

    .batch-info-card {
        border: 1px solid #e3f2fd;
        background: linear-gradient(135deg, #f8fffe 0%, #f0f9ff 100%);
    }

    .batch-info-card .card-header {
        background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
        border-bottom: 1px solid #b3e5fc;
    }
</style>
{% endblock %}

{% block content %}
<div class="results-viewer">
    <div class="results-container">
        <!-- Header -->
        <div class="text-center text-white mb-4">
            <h1 class="display-4 fw-bold mb-3">
                <i class="bi bi-bar-chart me-3"></i>
                Results Viewer
            </h1>
            <p class="lead">
                View and analyze algorithm execution results
            </p>
        </div>

        <!-- Simple Results Browser -->
        <div class="results-card" id="resultsBrowserCard">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div><i class="bi bi-folder2-open me-2"></i>Available Works</div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary" id="btnRefreshWorks"><i class="bi bi-arrow-clockwise me-1"></i>Refresh</button>
                    <button class="btn btn-sm btn-outline-primary" id="btnDownloadSelected" disabled><i class="bi bi-archive me-1"></i>Download Selected</button>
                    <button class="btn btn-sm btn-outline-success" id="btnDownloadAll" disabled><i class="bi bi-download me-1"></i>ZIP All</button>
                </div>
            </div>
            <div class="p-3">
                <div class="row g-3">
                    <div class="col-md-4">
                        <h6 class="text-muted text-uppercase small mb-2"><i class="bi bi-collection me-1"></i>Works</h6>
                        <ul class="list-group small" id="worksList"></ul>
                        <div class="text-muted small mt-2" id="worksStatus">Loading...</div>
                    </div>
                    <div class="col-md-8">
                        <!-- Batch Information Panel -->
                        <div class="card mb-3 d-none batch-info-card" id="batchInfoCard">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Batch Information
                                </h6>
                            </div>
                            <div class="card-body py-2 small">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div><strong>Name:</strong> <span id="batchName">—</span></div>
                                        <div><strong>Author:</strong> <span id="batchAuthor">—</span></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div><strong>Version:</strong> <span id="batchVersion">—</span></div>
                                        <div><strong>Created:</strong> <span id="batchDate">—</span></div>
                                    </div>
                                    <div class="col-12" id="batchDescContainer" style="display:none;">
                                        <div><strong>Description:</strong> <span id="batchDescription">—</span></div>
                                    </div>
                                    <div class="col-12" id="batchTagsContainer" style="display:none;">
                                        <div><strong>Tags:</strong> <span id="batchTags">—</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Files Section -->
                        <h6 class="text-muted text-uppercase small mb-2 d-flex align-items-center gap-2">
                            <i class="bi bi-files"></i><span id="filesTitle">Files</span>
                        </h6>
                        <div class="table-responsive border rounded" style="max-height:480px; overflow:auto;">
                            <table class="table table-sm align-middle mb-0" id="filesTable">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width:32px;"><input type="checkbox" id="selectAllFiles" disabled></th>
                                        <th>Name</th>
                                        <th class="text-end" style="width:100px;">Size</th>
                                        <th style="width:48px;">&nbsp;</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2 small">
                            <div id="selectedCount">0 selected</div>
                            <div id="workMeta" class="text-muted"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const els = {
        worksList: document.getElementById('worksList'),
        worksStatus: document.getElementById('worksStatus'),
        filesTableBody: document.querySelector('#filesTable tbody'),
        selectAll: document.getElementById('selectAllFiles'),
        btnDownloadSelected: document.getElementById('btnDownloadSelected'),
        btnDownloadAll: document.getElementById('btnDownloadAll'),
        btnRefreshWorks: document.getElementById('btnRefreshWorks'),
        filesTitle: document.getElementById('filesTitle'),
        selectedCount: document.getElementById('selectedCount'),
        workMeta: document.getElementById('workMeta'),
        batchInfoCard: document.getElementById('batchInfoCard'),
        batchName: document.getElementById('batchName'),
        batchAuthor: document.getElementById('batchAuthor'),
        batchVersion: document.getElementById('batchVersion'),
        batchDate: document.getElementById('batchDate'),
        batchDescription: document.getElementById('batchDescription'),
        batchDescContainer: document.getElementById('batchDescContainer'),
        batchTags: document.getElementById('batchTags'),
        batchTagsContainer: document.getElementById('batchTagsContainer'),
    };

    let currentWork = null;
    let currentFiles = [];

    function fmtSize(bytes){
        if(bytes < 1024) return bytes + ' B';
        if(bytes < 1024*1024) return (bytes/1024).toFixed(1)+' KB';
        return (bytes/1024/1024).toFixed(1)+' MB';
    }

    async function fetchJSON(url, opts) {
        const res = await fetch(url, opts);
        if(!res.ok) throw new Error(await res.text());
        return res.json();
    }

    async function loadWorks(){
        els.worksStatus.textContent = 'Loading...';
        els.worksList.innerHTML='';
        try {
            const works = await fetchJSON('/api/files/works');
            if(!works.length){
                els.worksStatus.textContent = 'No works found';
                return;
            }
            works.sort((a,b)=> b.modified - a.modified);
            for(const w of works){
                const li = document.createElement('li');
                li.className='list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                li.style.cursor='pointer';
                li.innerHTML = `<span><i class="bi bi-hdd-network me-1"></i>${w.work_id}</span><span class="badge bg-secondary">${w.manifest?.status || '—'}</span>`;
                li.addEventListener('click',()=> selectWork(w, li));
                els.worksList.appendChild(li);
            }
            els.worksStatus.textContent = works.length + ' works';
        } catch(e){
            console.error(e); els.worksStatus.textContent='Error loading works';
        }
    }

    async function selectWork(work, li){
        currentWork = work;
        for(const c of els.worksList.children) c.classList.remove('active');
        li.classList.add('active');
        els.filesTitle.textContent = 'Files for ' + work.work_id;
        els.workMeta.textContent = work.manifest ? (work.manifest.algorithm_count ? `${work.manifest.algorithm_count} algs` : '') : '';
        await loadBatchInfo(work.work_id);
        await loadFiles(work.work_id);
    }

    async function loadBatchInfo(workId){
        try {
            // Show card with loading state
            els.batchInfoCard.classList.remove('d-none');
            els.batchName.textContent = 'Loading...';
            els.batchAuthor.textContent = 'Loading...';
            els.batchVersion.textContent = 'Loading...';
            els.batchDate.textContent = 'Loading...';
            els.batchDescContainer.style.display = 'none';
            els.batchTagsContainer.style.display = 'none';
            
            const workStatus = await fetchJSON(`/api/monitor/work/${workId}/status`);
            const config = workStatus.config || {};
            const metadata = config.metadata || {};
            
            // Update batch information
            els.batchName.textContent = metadata.name || 'Unknown';
            els.batchAuthor.textContent = metadata.author || 'Unknown';
            els.batchVersion.textContent = metadata.version || '—';
            els.batchDate.textContent = metadata.creation_date || '—';
            
            // Handle optional fields
            if (metadata.description && metadata.description.trim()) {
                els.batchDescription.textContent = metadata.description;
                els.batchDescContainer.style.display = 'block';
            } else {
                els.batchDescContainer.style.display = 'none';
            }
            
            if (metadata.tags && Array.isArray(metadata.tags) && metadata.tags.length > 0) {
                els.batchTags.innerHTML = metadata.tags.map(tag => 
                    `<span class="badge bg-secondary me-1">${tag}</span>`
                ).join('');
                els.batchTagsContainer.style.display = 'block';
            } else {
                els.batchTagsContainer.style.display = 'none';
            }
            
        } catch(e) {
            console.error('Failed to load batch info:', e);
            // Show error state
            els.batchName.textContent = 'Error loading batch info';
            els.batchAuthor.textContent = '—';
            els.batchVersion.textContent = '—';
            els.batchDate.textContent = '—';
            els.batchDescContainer.style.display = 'none';
            els.batchTagsContainer.style.display = 'none';
        }
    }

    async function loadFiles(workId){
        els.filesTableBody.innerHTML = '<tr><td colspan="4" class="text-muted">Loading...</td></tr>';
        els.selectAll.disabled = true;
        currentFiles = [];
        try {
            const data = await fetchJSON(`/api/files/list/${workId}`);
            const all = data.all || [];
            currentFiles = all;
            renderFiles();
        } catch(e){
            els.filesTableBody.innerHTML = '<tr><td colspan="4" class="text-danger">Failed to load files</td></tr>';
        }
    }

    function renderFiles(){
        if(!currentFiles.length){
            els.filesTableBody.innerHTML = '<tr><td colspan="4" class="text-muted">No files</td></tr>';
            els.selectAll.checked=false; els.selectAll.disabled=true;
            els.btnDownloadAll.disabled=true; els.btnDownloadSelected.disabled=true;
            els.selectedCount.textContent='0 selected';
            return;
        }
        els.selectAll.disabled=false; els.btnDownloadAll.disabled=false;
        els.filesTableBody.innerHTML = currentFiles.map(f=>`<tr>
            <td><input type="checkbox" class="file-check" data-path="${encodeURIComponent(f.path)}"></td>
            <td><code>${f.name}</code></td>
            <td class="text-end">${fmtSize(f.size)}</td>
            <td class="text-center"><a href="/api/files/download?path=${encodeURIComponent(f.path)}" class="btn btn-sm btn-outline-secondary" title="Download"><i class="bi bi-download"></i></a></td>
        </tr>`).join('');
        updateSelectionState();
    }

    function getSelectedPaths(){
        return Array.from(document.querySelectorAll('.file-check:checked')).map(c=> decodeURIComponent(c.dataset.path));
    }

    function updateSelectionState(){
        const sel = getSelectedPaths();
        els.btnDownloadSelected.disabled = sel.length === 0;
        els.selectedCount.textContent = sel.length + ' selected';
        if(sel.length && sel.length === currentFiles.length){
            els.selectAll.checked = true;
        } else {
            els.selectAll.checked = false;
        }
    }

    els.filesTableBody.addEventListener('change', (e)=>{
        if(e.target.classList.contains('file-check')) updateSelectionState();
    });
    els.selectAll.addEventListener('change', ()=>{
        const checked = els.selectAll.checked;
        document.querySelectorAll('.file-check').forEach(c=> c.checked = checked);
        updateSelectionState();
    });
    els.btnRefreshWorks.addEventListener('click', loadWorks);
    els.btnDownloadAll.addEventListener('click', ()=>{
        if(!currentWork) return;
        window.location = `/api/files/download-zip/${currentWork.work_id}`;
    });
    els.btnDownloadSelected.addEventListener('click', async ()=>{
        if(!currentWork) return;
        const sel = getSelectedPaths();
        if(!sel.length) return;
        try {
            const res = await fetch(`/api/files/download-zip-selected/${currentWork.work_id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sel)
            });
            if(!res.ok) throw new Error('Download failed');
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `execution_${currentWork.work_id}_selected.zip`;
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        } catch(e){ console.error(e); }
    });

        function applyHashSelection(){
            if(!location.hash) return;
            const m = location.hash.match(/work=([^&]+)/);
            if(m){
                const target = decodeURIComponent(m[1]);
                // aguardar works carregados
                const trySelect = ()=>{
                    const items = Array.from(els.worksList.children);
                    const li = items.find(li=> li.textContent.trim().startsWith(target));
                    if(li){ li.click(); return true; }
                    return false;
                };
                let attempts = 0;
                const interval = setInterval(()=>{
                    attempts++; if(trySelect() || attempts>20) clearInterval(interval);
                }, 150);
            }
        }

        loadWorks().then(applyHashSelection);
});
</script>
{% endblock %}
