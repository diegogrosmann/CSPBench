{% extends "base.html" %}

{% block title %}Results Manager - CSPBench{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">
    <i class="bi bi-download me-1"></i>Results
</li>
{% endblock %}

{% block header %}
<div class="text-center mb-5">
    <div class="hero-section p-5 rounded-4 shadow" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h1 class="display-4 fw-bold text-white mb-3">
            <i class="bi bi-download me-3"></i>Results Manager
        </h1>
        <p class="lead text-white-50 mb-0">
            Browse, download, and manage your CSPBench execution results
        </p>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Results Summary -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center shadow-sm border-0 bg-primary bg-opacity-10 stats-card">
            <div class="card-body py-4">
                <i class="bi bi-file-earmark-text fs-1 text-primary mb-3 stats-icon"></i>
                <h4 class="card-title text-primary fw-bold" id="total-sessions">-</h4>
                <p class="card-text text-muted mb-0">Total Sessions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm border-0 bg-info bg-opacity-10 stats-card">
            <div class="card-body py-4">
                <i class="bi bi-hdd fs-1 text-info mb-3 stats-icon"></i>
                <h4 class="card-title text-info fw-bold" id="total-size">-</h4>
                <p class="card-text text-muted mb-0">Total Size</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm border-0 bg-success bg-opacity-10 stats-card">
            <div class="card-body py-4">
                <i class="bi bi-check-circle fs-1 text-success mb-3 stats-icon"></i>
                <h4 class="card-title text-success fw-bold" id="completed-sessions">-</h4>
                <p class="card-text text-muted mb-0">Completed</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm border-0 bg-danger bg-opacity-10 stats-card">
            <div class="card-body py-4">
                <i class="bi bi-x-circle fs-1 text-danger mb-3 stats-icon"></i>
                <h4 class="card-title text-danger fw-bold" id="failed-sessions">-</h4>
                <p class="card-text text-muted mb-0">Failed</p>
            </div>
        </div>
    </div>
</div>

<!-- Results Table -->
<div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="bi bi-table me-2"></i>Execution Results
        </h5>
        <div class="d-flex align-items-center gap-3">
            <span class="badge bg-secondary text-nowrap" id="selected-count">0 selected</span>
            <div class="btn-group btn-group-sm" role="group" id="batch-actions" style="display: none;">
                <button class="btn btn-outline-success" id="download-selected" disabled>
                    <i class="bi bi-download me-1"></i>Download
                </button>
                <button class="btn btn-outline-danger" id="delete-selected" disabled>
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="toggle-filters" data-bs-toggle="collapse" data-bs-target="#filters-section" aria-expanded="false">
                    <i class="bi bi-funnel me-1"></i>Filters
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="refresh-results">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
    
    <!-- Collapsible Filters Section -->
    <div class="collapse" id="filters-section">
        <div class="card-body border-bottom bg-light">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="search-query" class="form-label">Search</label>
                    <input type="text" class="form-control" id="search-query" placeholder="Session ID, algorithm, dataset...">
                </div>
                <div class="col-md-2">
                    <label for="filter-date-from" class="form-label">From Date</label>
                    <input type="date" class="form-control" id="filter-date-from">
                </div>
                <div class="col-md-2">
                    <label for="filter-date-to" class="form-label">To Date</label>
                    <input type="date" class="form-control" id="filter-date-to">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100" id="apply-filters">
                        <i class="bi bi-search me-1"></i>Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-body p-0">
        <!-- Loading indicator -->
        <div id="loading-indicator" class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading results...</p>
        </div>

        <!-- Results table -->
        <div class="table-responsive" id="results-table-container" style="display: none;">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="50">
                            <input type="checkbox" class="form-check-input" id="select-all-checkbox">
                        </th>
                        <th>Session ID</th>
                        <th>Timestamp</th>
                        <th>Status</th>
                        <th>Size</th>
                        <th width="200">Actions</th>
                    </tr>
                </thead>
                <tbody id="results-table-body">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>

        <!-- Empty state -->
        <div id="empty-state" class="text-center p-5" style="display: none;">
            <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
            <h5 class="text-muted">No results found</h5>
            <p class="text-muted">Try adjusting your filters or run some algorithms first.</p>
            <a href="/execution/single" class="btn btn-primary">
                <i class="bi bi-play-circle me-1"></i>Run Algorithm
            </a>
        </div>

        <!-- Error state -->
        <div id="error-state" class="text-center p-5" style="display: none;">
            <i class="bi bi-exclamation-triangle fs-1 text-warning mb-3"></i>
            <h5 class="text-warning">Error loading results</h5>
            <p class="text-muted" id="error-message">An unexpected error occurred.</p>
            <button class="btn btn-outline-primary" id="retry-load">
                <i class="bi bi-arrow-clockwise me-1"></i>Retry
            </button>
        </div>
    </div>
</div>

<!-- Pagination -->
<nav aria-label="Results pagination" class="mt-4" id="pagination-container" style="display: none;">
    <ul class="pagination justify-content-center" id="pagination">
        <!-- Dynamic pagination -->
    </ul>
</nav>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the selected result(s)?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Result Details Modal -->
<div class="modal fade" id="resultDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Result Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="result-details-content">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.status-badge {
    font-size: 0.75rem;
}

.status-completed {
    background-color: #d1edff;
    color: #0c5460;
}

.status-failed {
    background-color: #f8d7da;
    color: #721c24;
}

.status-timeout {
    background-color: #fff3cd;
    color: #856404;
}

.session-row:hover {
    background-color: rgba(0,123,255,0.1);
}

.session-checkbox {
    transform: scale(1.2);
}

.action-btn {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

.table th {
    border-top: none;
    font-weight: 600;
    background-color: #f8f9fa;
}

.results-card {
    transition: all 0.3s ease;
}

.results-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Statistics cards enhancement */
.stats-card {
    transition: all 0.3s ease;
    cursor: default;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.stats-icon {
    transition: transform 0.3s ease;
}

.stats-card:hover .stats-icon {
    transform: scale(1.1);
}

.bg-primary.bg-opacity-10 {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.bg-info.bg-opacity-10 {
    background-color: rgba(13, 202, 240, 0.1) !important;
}

.bg-success.bg-opacity-10 {
    background-color: rgba(25, 135, 84, 0.1) !important;
}

.bg-danger.bg-opacity-10 {
    background-color: rgba(220, 53, 69, 0.1) !important;
}

/* Batch actions styling */
#batch-actions {
    transition: all 0.3s ease;
}

#selection-actions {
    transition: all 0.3s ease;
    border-top: 1px solid #dee2e6;
    padding-top: 1rem;
    margin-top: 1rem !important;
}

.selected-count-badge {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
}

/* Smooth show/hide animations */
.fade-in {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="/static/js/components/results-manager.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const resultsManager = new ResultsManager();
    resultsManager.initialize();
});
</script>
{% endblock %}
