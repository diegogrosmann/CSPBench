{% extends "base.html" %}

{% block title %}Monitoramento de Execução - CSPBench{% endblock %}

{% block extra_css %}
<style>
    /* Variáveis CSS */
    :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --border-radius: 8px;
        --shadow: 0 2px 10px rgba(0,0,0,0.1);
        --transition: all 0.3s ease;
    }

    /* Layout principal */
    .monitoring-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    /* Cards principais */
    .dashboard-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
        overflow: hidden;
        transition: var(--transition);
    }

    .dashboard-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .card-header {
        background: var(--light-color);
        border-bottom: 1px solid #dee2e6;
        padding: 1.5rem;
        position: relative;
    }

    .card-header h5 {
        margin: 0;
        color: var(--dark-color);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    /* Status badges */
    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .status-running {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
    }

    .status-completed {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }

    .status-failed {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
    }

    .status-pending {
        background: #f3e5f5;
        color: #7b1fa2;
        border: 1px solid #e1bee7;
    }

    /* Progress bars modernos */
    .modern-progress {
        background: #e9ecef;
        border-radius: 10px;
        height: 12px;
        overflow: hidden;
        position: relative;
        margin: 0.5rem 0;
    }

    .modern-progress-bar {
        height: 100%;
        border-radius: 10px;
        transition: width 0.6s ease;
        position: relative;
        background: linear-gradient(90deg, var(--primary-color), #4dabf7);
    }

    .modern-progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, 
            transparent 25%, 
            rgba(255,255,255,0.3) 25%, 
            rgba(255,255,255,0.3) 50%, 
            transparent 50%, 
            transparent 75%, 
            rgba(255,255,255,0.3) 75%
        );
        background-size: 20px 20px;
        animation: progress-animation 1s linear infinite;
    }

    @keyframes progress-animation {
        0% { background-position: 0 0; }
        100% { background-position: 20px 0; }
    }

    /* Grid de estatísticas */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
        background: var(--light-color);
        border-radius: var(--border-radius);
        border: 1px solid #dee2e6;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
        display: block;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 0.25rem;
    }

    /* Tabela de execuções */
    .executions-table {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }

    .table {
        margin-bottom: 0;
    }

    .table th {
        background: var(--light-color);
        border: none;
        font-weight: 600;
        color: var(--dark-color);
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        padding: 1rem 0.75rem;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table td {
        padding: 0.75rem;
        border-color: #f1f3f4;
        vertical-align: middle;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    /* Expandable rows */
    .expandable-row {
        cursor: pointer;
        transition: var(--transition);
    }

    .expanded-content {
        background: #f8f9fa;
        border-left: 4px solid var(--primary-color);
    }

    .callbacks-container {
        padding: 1rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .callback-item {
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-left: 4px solid #dee2e6;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .callback-type {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .callback-message {
        font-size: 0.9rem;
        color: var(--dark-color);
    }

    .callback-time {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    /* Callbacks por tipo */
    .callback-info { border-left-color: var(--info-color); }
    .callback-warning { border-left-color: var(--warning-color); }
    .callback-error { border-left-color: var(--danger-color); }
    .callback-success { border-left-color: var(--success-color); }

    /* Controles */
    .control-panel {
        background: white;
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .refresh-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .connection-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .connected {
        background: #e8f5e8;
        color: #2e7d32;
    }

    .disconnected {
        background: #ffebee;
        color: #c62828;
    }

    .connection-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Metadados do batch */
    .batch-metadata {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .metadata-item {
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 3px solid var(--primary-color);
    }

    .metadata-label {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
    }

    .metadata-value {
        color: #6c757d;
        font-size: 0.9rem;
        word-break: break-word;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 0 0.5rem;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .control-panel {
            flex-direction: column;
            align-items: stretch;
        }
    }

    /* Utilitários */
    .text-monospace {
        font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Progress with labels */
    .progress-with-label {
        margin-bottom: 1rem;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .progress-title {
        font-weight: 600;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .progress-counter {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="monitoring-dashboard">
    <div class="dashboard-container">
        
        <!-- Controles de Atualização -->
        <div class="control-panel">
            <div class="refresh-controls">
                <button id="refresh-btn" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                    <label class="form-check-label" for="auto-refresh">Auto-refresh (5s)</label>
                </div>
            </div>
            <div class="connection-indicator" id="connection-status">
                <div class="connection-dot"></div>
                <span>Conectado</span>
            </div>
        </div>

        <!-- Informações do Batch -->
        <div class="dashboard-card" id="batch-info-card" style="display: none;">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Informações do Batch</h5>
            </div>
            <div class="card-body">
                <div id="batch-metadata" class="batch-metadata"></div>
            </div>
        </div>

        <!-- Status da Execução -->
        <div class="dashboard-card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Status da Execução</h5>
            </div>
            <div class="card-body">
                <!-- Estatísticas Gerais -->
                <div class="stats-grid" id="execution-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="total-experiments">-</span>
                        <span class="stat-label">Total de Experimentos</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="completed-experiments">-</span>
                        <span class="stat-label">Completados</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="failed-experiments">-</span>
                        <span class="stat-label">Falharam</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="execution-time">-</span>
                        <span class="stat-label">Tempo de Execução</span>
                    </div>
                </div>

                <!-- Barras de Progresso -->
                <div id="progress-section" style="margin-top: 2rem;">
                    
                    <!-- Progresso Geral -->
                    <div class="progress-with-label">
                        <div class="progress-label">
                            <span class="progress-title">
                                <i class="fas fa-chart-pie"></i>
                                Progresso Geral
                            </span>
                            <span class="progress-counter" id="overall-counter">0 / 0</span>
                        </div>
                        <div class="modern-progress">
                            <div class="modern-progress-bar" id="overall-progress" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Execução Atual -->
                    <div class="progress-with-label">
                        <div class="progress-label">
                            <span class="progress-title">
                                <i class="fas fa-play"></i>
                                <span id="current-execution-name">Aguardando...</span>
                            </span>
                            <span class="progress-counter" id="execution-counter">0 / 0</span>
                        </div>
                        <div class="modern-progress">
                            <div class="modern-progress-bar" id="execution-progress" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Dataset Atual -->
                    <div class="progress-with-label">
                        <div class="progress-label">
                            <span class="progress-title">
                                <i class="fas fa-database"></i>
                                <span id="current-dataset-name">Aguardando...</span>
                            </span>
                            <span class="progress-counter" id="dataset-counter">0 / 0</span>
                        </div>
                        <div class="modern-progress">
                            <div class="modern-progress-bar" id="dataset-progress" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Algoritmo Atual -->
                    <div class="progress-with-label">
                        <div class="progress-label">
                            <span class="progress-title">
                                <i class="fas fa-cogs"></i>
                                <span id="current-algorithm-name">Aguardando...</span>
                            </span>
                            <span class="progress-counter" id="algorithm-counter">0 / 0</span>
                        </div>
                        <div class="modern-progress">
                            <div class="modern-progress-bar" id="algorithm-progress" style="width: 0%"></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Execuções Detalhadas -->
        <div class="dashboard-card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Execuções Detalhadas</h5>
            </div>
            <div class="card-body">
                <div class="executions-table">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Execução</th>
                                    <th>Dataset</th>
                                    <th>Algoritmo</th>
                                    <th>Repetição</th>
                                    <th>Status</th>
                                    <th>Tempo Início</th>
                                    <th>Duração</th>
                                    <th>Callbacks</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="executions-tbody">
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span class="ms-2">Carregando execuções...</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs da Sessão -->
        <div class="dashboard-card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-terminal"></i> Logs da Sessão
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleLogsSection()">
                        <i class="fas fa-chevron-down" id="logs-toggle-icon"></i>
                    </button>
                </h5>
            </div>
            <div class="card-body" id="logs-section" style="display: none;">
                <div id="logs-container" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; border-radius: 4px; padding: 1rem; font-family: monospace; font-size: 0.9rem;">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Carregando logs...
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let sessionId = "{{ session_id }}";
    let isConnected = false;
    let refreshInterval = null;
    let expandedRows = new Set();

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('CSPBench WebDisplay - Initializing...');
        if (sessionId) {
            console.log('Session ID:', sessionId);
            startAutoRefresh();
            refreshProgressData();
        } else {
            console.error('No session ID provided');
            updateConnectionStatus(false);
        }
        setupEventListeners();
    });

    function setupEventListeners() {
        // Refresh button
        document.getElementById('refresh-btn').addEventListener('click', function() {
            refreshProgressData();
        });
        
        // Auto-refresh toggle
        document.getElementById('auto-refresh').addEventListener('change', function() {
            if (this.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
    }

    function startAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(refreshProgressData, 5000);
    }

    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    async function refreshProgressData() {
        try {
            const response = await fetch(`/execution/api/progress/${sessionId}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.success && result.data) {
                updateUI(result.data);
                updateConnectionStatus(true);
            } else {
                throw new Error('Invalid response format');
            }

        } catch (error) {
            console.error('Error fetching progress data:', error);
            updateConnectionStatus(false);
        }
    }

    function updateUI(data) {
        const { batch_structure, execution_status, callbacks_history } = data;
        
        // Update batch info
        if (batch_structure) {
            updateBatchInfo(batch_structure);
        }
        
        // Update execution status
        if (execution_status) {
            updateExecutionStatus(execution_status);
        }
        
        // Update executions table
        if (callbacks_history) {
            updateExecutionsTable(callbacks_history);
        }
    }

    function updateBatchInfo(batchStructure) {
        if (!batchStructure || Object.keys(batchStructure).length === 0) {
            return;
        }

        const card = document.getElementById('batch-info-card');
        const container = document.getElementById('batch-metadata');
        
        const metadata = batchStructure.metadata || {};
        
        container.innerHTML = [
            { label: 'Nome', value: metadata.name || '-' },
            { label: 'Descrição', value: metadata.description || '-' },
            { label: 'Versão', value: metadata.version || '-' },
            { label: 'Autor', value: metadata.author || '-' },
            { label: 'Email', value: metadata.email || '-' },
            { label: 'Criado em', value: formatDate(metadata.created_at || batchStructure.created_at) },
            { label: 'Total Execuções', value: batchStructure.total_executions || '-' },
            { label: 'Total Experimentos', value: batchStructure.total_experiments || '-' }
        ].map(item => `
            <div class="metadata-item">
                <div class="metadata-label">${item.label}</div>
                <div class="metadata-value">${item.value}</div>
            </div>
        `).join('');

        card.style.display = 'block';
    }

    function updateExecutionStatus(executionStatus) {
        // Update overall stats
        document.getElementById('total-experiments').textContent = executionStatus.total_experiments || 0;
        document.getElementById('completed-experiments').textContent = executionStatus.completed_experiments || 0;
        document.getElementById('failed-experiments').textContent = executionStatus.failed_experiments || 0;
        document.getElementById('execution-time').textContent = formatDuration(executionStatus.execution_time_seconds);

        // Update current execution info
        const current = executionStatus.current_execution || {};
        document.getElementById('current-execution-name').textContent = current.name || 'Aguardando...';
        document.getElementById('current-dataset-name').textContent = current.dataset || 'Aguardando...';
        document.getElementById('current-algorithm-name').textContent = current.algorithm || 'Aguardando...';

        // Update progress bars
        updateProgressBar('overall', executionStatus.completed_experiments || 0, executionStatus.total_experiments || 1);
        updateProgressBar('execution', current.completed_runs || 0, current.total_runs || 1);
        updateProgressBar('dataset', current.dataset_position || 0, current.total_datasets || 1);
        updateProgressBar('algorithm', current.algorithm_position || 0, current.total_algorithms || 1);
    }

    function updateProgressBar(type, current, total) {
        const percentage = total > 0 ? (current / total) * 100 : 0;
        
        // Update counter
        const counter = document.getElementById(type + '-counter');
        if (counter) {
            counter.textContent = `${current} / ${total}`;
        }
        
        // Update progress bar
        const progressBar = document.getElementById(type + '-progress');
        if (progressBar) {
            progressBar.style.width = percentage + '%';
        }
    }

    function updateExecutionsTable(callbacksHistory) {
        const tbody = document.getElementById('executions-tbody');
        
        if (!callbacksHistory || Object.keys(callbacksHistory).length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <i class="fas fa-inbox"></i>
                        <span class="ms-2">Nenhuma execução encontrada</span>
                    </td>
                </tr>
            `;
            return;
        }

        const executions = [];
        
        // Convert callbacks_history to executions list
        Object.entries(callbacksHistory).forEach(([key, repetition]) => {
            if (repetition.metadata) {
                executions.push({
                    id: key,
                    execution_name: repetition.metadata.execution_name || '-',
                    dataset_name: repetition.metadata.dataset_name || '-',
                    algorithm_name: repetition.metadata.algorithm_name || '-',
                    repetition_number: repetition.metadata.repetition_number || 1,
                    status: repetition.status || 'pending',
                    start_time: repetition.start_time || null,
                    end_time: repetition.end_time || null,
                    callbacks: repetition.callbacks || []
                });
            }
        });

        tbody.innerHTML = executions.map(exec => {
            const duration = calculateDuration(exec.start_time, exec.end_time);
            const isExpanded = expandedRows.has(exec.id);
            
            return `
                <tr class="expandable-row" onclick="toggleExecutionDetails('${exec.id}')">
                    <td>${exec.execution_name}</td>
                    <td>${exec.dataset_name}</td>
                    <td>${exec.algorithm_name}</td>
                    <td>
                        <span class="badge bg-secondary">#${exec.repetition_number}</span>
                    </td>
                    <td>
                        <span class="status-badge status-${exec.status}">
                            ${getStatusIcon(exec.status)} ${getStatusText(exec.status)}
                        </span>
                    </td>
                    <td>${formatTime(exec.start_time)}</td>
                    <td>${duration}</td>
                    <td>
                        <span class="badge bg-info">${exec.callbacks.length}</span>
                    </td>
                    <td>
                        <i class="fas fa-chevron-${isExpanded ? 'up' : 'down'}"></i>
                    </td>
                </tr>
                ${isExpanded ? `
                <tr class="expanded-content">
                    <td colspan="9">
                        <div class="callbacks-container">
                            <h6><i class="fas fa-list"></i> Callbacks (${exec.callbacks.length})</h6>
                            ${renderCallbacks(exec.callbacks)}
                        </div>
                    </td>
                </tr>
                ` : ''}
            `;
        }).join('');
    }

    function toggleExecutionDetails(executionId) {
        if (expandedRows.has(executionId)) {
            expandedRows.delete(executionId);
        } else {
            expandedRows.add(executionId);
        }
        // Refresh the table to show/hide details
        updateExecutionsTable(window.lastCallbacksHistory);
    }

    function renderCallbacks(callbacks) {
        if (!callbacks || callbacks.length === 0) {
            return '<div class="text-muted">Nenhum callback registrado</div>';
        }

        return callbacks.map(callback => `
            <div class="callback-item callback-${callback.level || 'info'}">
                <div class="callback-type">${(callback.level || 'info').toUpperCase()}</div>
                <div class="callback-message">${callback.message || callback.content || ''}</div>
                <div class="callback-time">${formatTime(callback.timestamp)}</div>
                ${callback.algorithm_name ? `<div class="mt-1"><small><strong>Algoritmo:</strong> ${callback.algorithm_name}</small></div>` : ''}
            </div>
        `).join('');
    }

    function updateConnectionStatus(connected) {
        const statusElement = document.getElementById('connection-status');
        isConnected = connected;
        
        if (connected) {
            statusElement.className = 'connection-indicator connected';
            statusElement.innerHTML = '<div class="connection-dot"></div><span>Conectado</span>';
        } else {
            statusElement.className = 'connection-indicator disconnected';
            statusElement.innerHTML = '<div class="connection-dot"></div><span>Desconectado</span>';
        }
    }

    function toggleLogsSection() {
        const section = document.getElementById('logs-section');
        const icon = document.getElementById('logs-toggle-icon');
        
        if (section.style.display === 'none') {
            section.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
        } else {
            section.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
        }
    }

    // Utility functions
    function getStatusIcon(status) {
        switch (status) {
            case 'completed': return '<i class="fas fa-check-circle"></i>';
            case 'running': return '<i class="fas fa-play-circle"></i>';
            case 'failed': return '<i class="fas fa-times-circle"></i>';
            case 'pending': return '<i class="fas fa-clock"></i>';
            default: return '<i class="fas fa-question-circle"></i>';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'completed': return 'Completado';
            case 'running': return 'Executando';
            case 'failed': return 'Falhou';
            case 'pending': return 'Pendente';
            default: return 'Desconhecido';
        }
    }

    function formatTime(timeString) {
        if (!timeString) return '-';
        try {
            const date = new Date(timeString);
            return date.toLocaleTimeString();
        } catch {
            return timeString;
        }
    }

    function formatDate(dateString) {
        if (!dateString) return '-';
        try {
            const date = new Date(dateString);
            return date.toLocaleString();
        } catch {
            return dateString;
        }
    }

    function formatDuration(seconds) {
        if (!seconds) return '-';
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        if (hours > 0) {
            return `${hours}h ${minutes}m ${secs}s`;
        } else if (minutes > 0) {
            return `${minutes}m ${secs}s`;
        } else {
            return `${secs}s`;
        }
    }

    function calculateDuration(startTime, endTime) {
        if (!startTime) return '-';
        
        const start = new Date(startTime);
        const end = endTime ? new Date(endTime) : new Date();
        const diffMs = end - start;
        
        if (diffMs < 0) return '-';
        
        const diffSeconds = Math.floor(diffMs / 1000);
        return formatDuration(diffSeconds);
    }

    // Store callbacks history for toggle functionality
    window.addEventListener('storage', function(e) {
        if (e.key === 'lastCallbacksHistory') {
            window.lastCallbacksHistory = JSON.parse(e.newValue);
        }
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
    });
</script>
{% endblock %}
