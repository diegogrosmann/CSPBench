{% extends "base.html" %}

{% block title %}CSPBench - Single Execution{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">Single Execution</li>
{% endblock %}

{% block header %}
<div class="text-center mb-5">
    <div class="hero-section p-4 rounded-4 shadow" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h1 class="h2 fw-bold text-white mb-2">
            <i class="bi bi-rocket-takeoff me-3"></i>Single Algorithm Execution
        </h1>
        <p class="text-white-50 mb-0">
            Configure and execute a single algorithm on your dataset
        </p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Progress Stepper -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="step-item active" data-step="1">
                        <div class="step-circle">
                            <i class="bi bi-cpu"></i>
                        </div>
                        <span class="step-label">Algorithm</span>
                    </div>
                    <div class="step-connector"></div>
                    <div class="step-item" data-step="2">
                        <div class="step-circle">
                            <i class="bi bi-database"></i>
                        </div>
                        <span class="step-label">Dataset</span>
                    </div>
                    <div class="step-connector"></div>
                    <div class="step-item" data-step="3">
                        <div class="step-circle">
                            <i class="bi bi-sliders"></i>
                        </div>
                        <span class="step-label">Parameters</span>
                    </div>
                    <div class="step-connector"></div>
                    <div class="step-item" data-step="4">
                        <div class="step-circle">
                            <i class="bi bi-play-circle"></i>
                        </div>
                        <span class="step-label">Execute</span>
                    </div>
                </div>
            </div>
        </div>

        <form id="execution-form" class="execution-form">
            <!-- Step 1: Algorithm Selection -->
            <div class="form-step active" data-step="1">
                <div class="card shadow">
                    <div class="card-header">
                        <h4 class="card-title mb-0">
                            <i class="bi bi-cpu me-2 text-primary"></i>
                            Step 1: Select Algorithm
                        </h4>
                        <p class="card-subtitle text-muted mb-0 mt-1">
                            Choose the CSP algorithm you want to execute
                        </p>
                    </div>
                    <div class="card-body">
                        <div class="algorithm-selector-component" data-algorithm-selector>
                            <!-- Algorithm selector will be initialized here -->
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-primary btn-lg" onclick="nextStep()" disabled id="step1-next">
                                <i class="bi bi-arrow-right me-2"></i>
                                Next: Configure Dataset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Dataset Configuration -->
            <div class="form-step" data-step="2" style="display: none;">
                <div class="card shadow">
                    <div class="card-header">
                        <h4 class="card-title mb-0">
                            <i class="bi bi-database me-2 text-success"></i>
                            Step 2: Configure Dataset
                        </h4>
                        <p class="card-subtitle text-muted mb-0 mt-1">
                            Provide the dataset for algorithm execution
                        </p>
                    </div>
                    <div class="card-body">
                        <div class="dataset-selector-component">
                            <!-- Dataset selector will be initialized here -->
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="prevStep()">
                                <i class="bi bi-arrow-left me-2"></i>
                                Previous
                            </button>
                <button type="button" class="btn btn-primary" onclick="nextStep()" disabled id="step2-next">
                    Next: Set Parameters
                </button>
            </div>
        </div>
        
        <!-- Step 3: Parameter Configuration -->
        <div class="form-step" data-step="3">
            <div class="step-header">
                <h3><span class="step-number">3</span> Configure Parameters</h3>
                <p>Adjust algorithm parameters or use defaults.</p>
            </div>
            
            <div class="algorithm-config-component">
                <!-- This will be populated by the AlgorithmConfig component -->
            </div>
            
            <div class="execution-options">
                <h4>Execution Options</h4>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="save-history" name="save_history">
                        Save execution history
                    </label>
                </div>
                <div class="form-group">
                    <label for="timeout">Timeout (seconds):</label>
                    <input type="number" id="timeout" name="timeout" value="300" min="10" max="3600">
                </div>
                <div class="form-group">
                    <label for="seed">Random Seed (optional):</label>
                    <input type="number" id="seed" name="seed" placeholder="Leave empty for random">
                </div>
            </div>
            
            <div class="step-actions">
                <button type="button" class="btn btn-secondary" onclick="prevStep()">
                    Previous
                </button>
                <button type="button" class="btn btn-primary" onclick="nextStep()">
                    Next: Review & Execute
                </button>
            </div>
        </div>
        
        <!-- Step 4: Review and Execute -->
        <div class="form-step" data-step="4">
            <div class="step-header">
                <h3><span class="step-number">4</span> Review & Execute</h3>
                <p>Review your configuration and start the execution.</p>
            </div>
            
            <div class="execution-summary">
                <div class="summary-section">
                    <h4>Algorithm</h4>
                    <div id="summary-algorithm" class="summary-value">-</div>
                </div>
                <div class="summary-section">
                    <h4>Dataset</h4>
                    <div id="summary-dataset" class="summary-value">-</div>
                </div>
                <div class="summary-section">
                    <h4>Parameters</h4>
                    <div id="summary-parameters" class="summary-value">-</div>
                </div>
            </div>
            
            <div class="step-actions">
                <button type="button" class="btn btn-secondary" onclick="prevStep()">
                    Previous
                </button>
                <button type="submit" class="btn btn-success" id="execute-btn">
                    ðŸš€ Execute Algorithm
                </button>
            </div>
        </div>
    </form>
    
    <!-- Execution Monitor -->
    <div id="execution-monitor" class="execution-monitor-component" style="display: none;">
        <!-- This will be populated by the ExecutionMonitor component -->
    </div>
    
    <!-- Progress Indicator -->
    <div class="step-progress">
        <div class="progress-step active" data-step="1">
            <div class="progress-circle">1</div>
            <span>Algorithm</span>
        </div>
        <div class="progress-step" data-step="2">
            <div class="progress-circle">2</div>
            <span>Dataset</span>
        </div>
        <div class="progress-step" data-step="3">
            <div class="progress-circle">3</div>
            <span>Parameters</span>
        </div>
        <div class="progress-step" data-step="4">
            <div class="progress-circle">4</div>
            <span>Execute</span>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
let selectedAlgorithm = null;
let datasetConfig = null;
let algorithmConfig = null;

function nextStep() {
    if (currentStep < 4) {
        // Hide current step
        document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.remove('active');
        document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');
        
        // Show next step
        currentStep++;
        document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.add('active');
        document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('active');
        
        // Update summary if on step 4
        if (currentStep === 4) {
            updateExecutionSummary();
        }
    }
}

function prevStep() {
    if (currentStep > 1) {
        // Hide current step
        document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.remove('active');
        document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');
        
        // Show previous step
        currentStep--;
        document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.add('active');
        document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('active');
    }
}

function updateExecutionSummary() {
    // Update algorithm summary
    document.getElementById('summary-algorithm').textContent = 
        selectedAlgorithm ? selectedAlgorithm.name : 'Not selected';
    
    // Update dataset summary
    document.getElementById('summary-dataset').textContent = 
        datasetConfig ? `${datasetConfig.type} (${datasetConfig.size || 'N/A'} sequences)` : 'Not configured';
    
    // Update parameters summary
    const paramCount = algorithmConfig ? Object.keys(algorithmConfig).length : 0;
    document.getElementById('summary-parameters').textContent = 
        `${paramCount} parameters configured`;
}

// Form submission
document.getElementById('execution-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Hide form and show execution monitor
    document.querySelector('.execution-form').style.display = 'none';
    document.querySelector('.step-progress').style.display = 'none';
    document.getElementById('execution-monitor').style.display = 'block';
    
    // Start execution
    await executeAlgorithm();
});

async function executeAlgorithm() {
    try {
        const request = {
            algorithm: selectedAlgorithm.name,
            dataset_content: datasetConfig.content,
            dataset_name: datasetConfig.name || 'uploaded_dataset.fasta',
            parameters: algorithmConfig || {},
            save_history: document.getElementById('save-history').checked,
            timeout: parseInt(document.getElementById('timeout').value),
            seed: document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : null
        };
        
        const response = await fetch('/api/execute', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(request)
        });
        
        const result = await response.json();
        
        // Handle result in ExecutionMonitor component
        window.executionMonitor.handleResult(result);
        
    } catch (error) {
        console.error('Execution failed:', error);
        window.executionMonitor.handleError(error.message);
    }
}

// Initialize components when page loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('Initializing components...');
    
    // Check if API client is available
    if (!window.apiClient) {
        console.error('API client not loaded');
        return;
    }
    
    // Check if component classes are available
    if (!window.AlgorithmSelector) {
        console.error('AlgorithmSelector class not loaded');
        return;
    }
    
    console.log('All dependencies loaded, initializing components...');
    
    // Initialize Algorithm Selector
    window.algorithmSelector = new AlgorithmSelector('.algorithm-selector-component', {
        onSelect: (algorithm) => {
            console.log('Algorithm selected:', algorithm);
            selectedAlgorithm = algorithm;
            document.getElementById('step1-next').disabled = false;
        }
    });
    
    // Initialize Dataset Selector
    window.datasetSelector = new DatasetSelector('.dataset-selector-component', {
        onConfig: (config) => {
            console.log('Dataset configured:', config);
            datasetConfig = config;
            document.getElementById('step2-next').disabled = false;
        }
    });
    
    // Initialize Algorithm Config
    window.algorithmConfig = new AlgorithmConfig('.algorithm-config-component', {
        onConfig: (config) => {
            console.log('Algorithm config:', config);
            algorithmConfig = config;
        }
    });
    
    // Initialize Execution Monitor
    window.executionMonitor = new ExecutionMonitor('#execution-monitor');
    
    console.log('All components initialized');
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.single-execution-container {
    max-width: 800px;
    margin: 0 auto;
}

.execution-header {
    text-align: center;
    margin-bottom: 30px;
}

.execution-form {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.form-step {
    display: none;
}

.form-step.active {
    display: block;
}

.step-header {
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.step-number {
    display: inline-block;
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    text-align: center;
    line-height: 30px;
    margin-right: 10px;
    font-weight: bold;
}

.step-actions {
    margin-top: 30px;
    text-align: right;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    margin-left: 10px;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.execution-options {
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.execution-summary {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

.summary-section {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.summary-section h4 {
    margin: 0 0 10px 0;
    color: #495057;
}

.summary-value {
    font-weight: 600;
    color: #333;
}

.step-progress {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 30px 0;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0 20px;
    opacity: 0.5;
    transition: opacity 0.3s ease;
}

.progress-step.active {
    opacity: 1;
}

.progress-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 8px;
    transition: background 0.3s ease;
}

.progress-step.active .progress-circle {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.progress-step span {
    font-size: 0.9em;
    color: #666;
}

@media (max-width: 768px) {
    .step-progress {
        flex-wrap: wrap;
    }
    
    .progress-step {
        margin: 10px;
    }
}
</style>
{% endblock %}
